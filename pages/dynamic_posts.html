<!DOCTYPE html>
<html>
<head>
    <title>ÁõñÊ•ºÂä®ÊÄÅËøõÂ∫¶</title>
    <meta charset="utf-8">
    <script src="../js/chart.umd.min.js"></script>
    <script src="../js/chartjs-plugin-datalabels.min.js"></script>
    <script src="../js/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 40px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
            min-height: 100vh;
        }

        .header {
            width: 100%;
            background: linear-gradient(135deg, #1e88e5, #1565c0);
            color: white;
            text-align: center;
            padding: 40px 0;
            margin-bottom: 30px;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .back-button {
            display: inline-block;
            padding: 12px 25px;
            background-color: #1e88e5;
            color: white;
            border: none;
            border-radius: 12px;
            text-decoration: none;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .back-button:hover {
            background-color: #1565c0;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            height: 650px;
        }

        .controls {
            margin: 130px 0;
            text-align: center;
        }

        .control-button {
            padding: 15px 30px;
            margin: 0 10px;
            background: #1e88e5;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .control-button:hover {
            background: #1565c0;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .date-label {
            position: absolute;
            bottom: 80px;
            right: 80px;
            font-size: 66px;
            color: rgba(0,0,0,0.1);
            font-weight: bold;
            font-family: 'Arial', sans-serif;
        }

        .chart-wrapper {
            position: relative;
            height: 600px;
        }

        @keyframes rankChange {
            0% { transform: translateY(0); }
            50% { transform: translateY(10px); }
            100% { transform: translateY(0); }
        }

        .podium-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }

        .podium-overlay.fade-out {
            opacity: 0;
        }

        .podium-container {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding: 20px;
            gap: 30px;
            margin-top: 300px;
            position: relative;
            z-index: 3;
        }

        .podium-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .podium-base {
            width: 160px;
            position: relative;
            border-radius: 10px 10px 0 0;
        }

        .podium-step.gold .podium-base { 
            height: 300px; 
            background: linear-gradient(135deg, #FFD700, #FFA000);
        }
        .podium-step.silver .podium-base { 
            height: 250px; 
            background: linear-gradient(135deg, #C0C0C0, #9E9E9E);
        }
        .podium-step.bronze .podium-base { 
            height: 200px; 
            background: linear-gradient(135deg, #CD7F32, #8D6E63);
        }

        .podium-block {
            width: 140px;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .winner-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-bottom: 10px;
            border: 6px solid white;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .winner-name {
            color: white;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .winner-score {
            color: white;
            font-size: 16px;
            margin-top: 5px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .celebration-item {
            position: absolute;
            font-size: 60px;
            animation: float 3s infinite;
            z-index: 3;
        }

        .celebration-group {
            position: relative;
            width: 800px;
            height: 600px;
            margin-top: 200px;
        }

        @keyframes float {
            0%, 100% { 
                transform: translate(0, 0); 
                opacity: 0.8;
            }
            50% { 
                transform: translate(var(--x, 20px), var(--y, -20px)); 
                opacity: 1;
            }
        }

        .close-podium {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .close-podium:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .confetti-container {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .celebration-container {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 3;
            pointer-events: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .award-button {
            display: none;  /* ÂàùÂßãÈöêËóè */
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(145deg, #FFD700, #FFA500);
            border: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 999;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .award-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        
        .award-button::before {
            content: "üèÜ";
            font-size: 24px;
            line-height: 60px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ÁõñÊ•ºÂä®ÊÄÅËøõÂ∫¶</h1>
    </div>
    <button class="award-button" title="Êü•ÁúãÈ¢ÅÂ•ñÂè∞"></button>

    <div class="container">
        <a href="../index.html" class="back-button">ËøîÂõûÈ¶ñÈ°µ</a>

        <div class="chart-wrapper">
            <div class="chart-container">
                <canvas id="rankingChart"></canvas>
            </div>
            <div id="dateLabel" class="date-label"></div>
        </div>
        <div class="controls">
            <button class="control-button" onclick="startAnimation()">Êí≠Êîæ</button>
            <button class="control-button" onclick="pauseAnimation()">ÊöÇÂÅú</button>
            <button class="control-button" onclick="resetAnimation()">ÈáçÁΩÆ</button>
        </div>
    </div>

    <div class="podium-overlay">
        <div class="close-podium">√ó</div>
        <div class="confetti-container"></div>
        <div class="celebration-container">
            <div class="celebration-group">
                <div class="celebration-item" style="top: 40%; left: -120px; --x: 30px; --y: -20px;">üéâ</div>
                <div class="celebration-item" style="top: 60%; left: -80px; --x: 20px; --y: -30px;">üèÜ</div>
                
                <div class="celebration-item" style="top: 40%; right: -120px; --x: -30px; --y: -20px;">üéä</div>
                <div class="celebration-item" style="top: 60%; right: -80px; --x: -20px; --y: -30px;">üí•</div>
                
            </div>
        </div>
        <div class="podium-container">
            <div class="podium-step silver">
                <div class="podium-block">
                    <img class="winner-avatar" src="" alt="2nd Place">
                    <div class="winner-name"></div>
                    <div class="winner-score"></div>
                </div>
                <div class="podium-base"></div>
            </div>
            <div class="podium-step gold">
                <div class="podium-block">
                    <div class="crown" style="font-size: 60px;">üëë</div>
                    <img class="winner-avatar" src="" alt="1st Place">
                    <div class="winner-name"></div>
                    <div class="winner-score"></div>
                </div>
                <div class="podium-base"></div>
            </div>
            <div class="podium-step bronze">
                <div class="podium-block">
                    <img class="winner-avatar" src="" alt="3rd Place">
                    <div class="winner-name"></div>
                    <div class="winner-score"></div>
                </div>
                <div class="podium-base"></div>
            </div>
        </div>
    </div>

    <script>
        const rankingsData = [{"date": "2025-01-01 00:00:00", "rankings": [[130294434, 81, "\u53f8\u547d\u2601"], [256060645, 68, "0UXDeNA"], [284179257, 62, "MOMO2.0"], [212945898, 52, "\u70b9\u89e3\u70b9\u89e3DJ"], ["pixiaodan", 49, "\u516d\u6247\u95e8\u5185\u674e\u94f6\u5fc3"], [260295198, 45, "\u5c0f\u624b\u7231\u73a9"], [231193411, 39, "\u5c0f\u5976\u8c46"], [282998964, 38, "\ud80c\udda1\ud80c\udd9d\ud80c\udd9f\ud80c\udd9c\ud80c\udd9e\ud80c\udd9f"], [278142675, 36, "\u864emo"], [243090410, 31, "momo"], [70348459, 28, "\u4f36\u4ec3\u7ed9\u4f60\u8bfa"], [260322814, 26, "FoFo"], [261080295, 23, "underdog"], [143523138, 21, "\u5984\u7559WL"], [275997314, 21, "\u9ea6\u8150\u5224\u5b98"]]}, {"date": "2025-01-02 00:00:00", "rankings": [[212945898, 204, "\u70b9\u89e3\u70b9\u89e3DJ"], [284179257, 193, "MOMO2.0"], [256060645, 137, "0UXDeNA"], [130294434, 129, "\u53f8\u547d\u2601"], [282998964, 100, "\ud80c\udda1\ud80c\udd9d\ud80c\udd9f\ud80c\udd9c\ud80c\udd9e\ud80c\udd9f"], [70348459, 95, "\u4f36\u4ec3\u7ed9\u4f60\u8bfa"], [260295198, 91, "\u5c0f\u624b\u7231\u73a9"], [217927735, 77, "momo"], [261080295, 76, "underdog"], [143523138, 76, "\u5984\u7559WL"], [231193411, 74, "\u5c0f\u5976\u8c46"], ["pixiaodan", 72, "\u516d\u6247\u95e8\u5185\u674e\u94f6\u5fc3"], [278142675, 69, "\u864emo"], [243090410, 58, "momo"], [282006542, 56, "\u6ca1\u4e8b\u558a\u4e00\u558a"]]}, {"date": "2025-01-03 00:00:00", "rankings": [[212945898, 334, "\u70b9\u89e3\u70b9\u89e3DJ"], [284179257, 302, "MOMO2.0"], [130294434, 216, "\u53f8\u547d\u2601"], [256060645, 171, "0UXDeNA"], [70348459, 163, "\u4f36\u4ec3\u7ed9\u4f60\u8bfa"], [282998964, 144, "\ud80c\udda1\ud80c\udd9d\ud80c\udd9f\ud80c\udd9c\ud80c\udd9e\ud80c\udd9f"], [143523138, 130, "\u5984\u7559WL"], [260295198, 115, "\u5c0f\u624b\u7231\u73a9"], [278142675, 108, "\u864emo"], [231193411, 107, "\u5c0f\u5976\u8c46"], [217927735, 104, "momo"], ["pixiaodan", 102, "\u516d\u6247\u95e8\u5185\u674e\u94f6\u5fc3"], [261080295, 96, "underdog"], [243090410, 91, "momo"], [121638847, 87, "\u9ed1\u5e2e\u718a\u732b"]]}, {"date": "2025-01-04 00:00:00", "rankings": [[212945898, 391, "\u70b9\u89e3\u70b9\u89e3DJ"], [284179257, 350, "MOMO2.0"], [130294434, 259, "\u53f8\u547d\u2601"], [256060645, 190, "0UXDeNA"], [70348459, 183, "\u4f36\u4ec3\u7ed9\u4f60\u8bfa"], [282998964, 163, "\ud80c\udda1\ud80c\udd9d\ud80c\udd9f\ud80c\udd9c\ud80c\udd9e\ud80c\udd9f"], [260295198, 154, "\u5c0f\u624b\u7231\u73a9"], [143523138, 152, "\u5984\u7559WL"], ["pixiaodan", 144, "\u516d\u6247\u95e8\u5185\u674e\u94f6\u5fc3"], [278142675, 134, "\u864emo"], [231193411, 126, "\u5c0f\u5976\u8c46"], [261080295, 125, "underdog"], [282998931, 124, "\u8000\u7956"], [217927735, 114, "momo"], [191902505, 113, "\u6697\u591c\u730e\u624b"]]}, {"date": "2025-01-05 00:00:00", "rankings": [[212945898, 454, "\u70b9\u89e3\u70b9\u89e3DJ"], [284179257, 387, "MOMO2.0"], [130294434, 340, "\u53f8\u547d\u2601"], [70348459, 210, "\u4f36\u4ec3\u7ed9\u4f60\u8bfa"], [256060645, 198, "0UXDeNA"], [282998964, 197, "\ud80c\udda1\ud80c\udd9d\ud80c\udd9f\ud80c\udd9c\ud80c\udd9e\ud80c\udd9f"], [260295198, 179, "\u5c0f\u624b\u7231\u73a9"], [278142675, 175, "\u864emo"], ["pixiaodan", 173, "\u516d\u6247\u95e8\u5185\u674e\u94f6\u5fc3"], [143523138, 163, "\u5984\u7559WL"], [191902505, 148, "\u6697\u591c\u730e\u624b"], [261080295, 131, "underdog"], [231193411, 130, "\u5c0f\u5976\u8c46"], [282998931, 127, "\u8000\u7956"], [121638847, 118, "\u9ed1\u5e2e\u718a\u732b"]]}, {"date": "2025-01-06 00:00:00", "rankings": [[212945898, 492, "\u70b9\u89e3\u70b9\u89e3DJ"], [284179257, 425, "MOMO2.0"], [130294434, 405, "\u53f8\u547d\u2601"], [282998964, 237, "\ud80c\udda1\ud80c\udd9d\ud80c\udd9f\ud80c\udd9c\ud80c\udd9e\ud80c\udd9f"], [70348459, 227, "\u4f36\u4ec3\u7ed9\u4f60\u8bfa"], [256060645, 220, "0UXDeNA"], [278142675, 217, "\u864emo"], [260295198, 207, "\u5c0f\u624b\u7231\u73a9"], ["pixiaodan", 197, "\u516d\u6247\u95e8\u5185\u674e\u94f6\u5fc3"], [143523138, 190, "\u5984\u7559WL"], [191902505, 170, "\u6697\u591c\u730e\u624b"], [261080295, 169, "underdog"], [121638847, 159, "\u9ed1\u5e2e\u718a\u732b"], [231193411, 154, "\u5c0f\u5976\u8c46"], [282998931, 144, "\u8000\u7956"]]}, {"date": "2025-01-07 00:00:00", "rankings": [[212945898, 562, "\u70b9\u89e3\u70b9\u89e3DJ"], [284179257, 498, "MOMO2.0"], [130294434, 433, "\u53f8\u547d\u2601"], [282998964, 276, "\ud80c\udda1\ud80c\udd9d\ud80c\udd9f\ud80c\udd9c\ud80c\udd9e\ud80c\udd9f"], [256060645, 270, "0UXDeNA"], ["pixiaodan", 268, "\u516d\u6247\u95e8\u5185\u674e\u94f6\u5fc3"], [278142675, 261, "\u864emo"], [70348459, 231, "\u4f36\u4ec3\u7ed9\u4f60\u8bfa"], [260295198, 229, "\u5c0f\u624b\u7231\u73a9"], [121638847, 202, "\u9ed1\u5e2e\u718a\u732b"], [191902505, 201, "\u6697\u591c\u730e\u624b"], [143523138, 198, "\u5984\u7559WL"], [261080295, 176, "underdog"], [231193411, 170, "\u5c0f\u5976\u8c46"], [282998931, 154, "\u8000\u7956"]]}, {"date": "2025-01-08 00:00:00", "rankings": [[212945898, 623, "\u70b9\u89e3\u70b9\u89e3DJ"], [284179257, 614, "MOMO2.0"], [130294434, 508, "\u53f8\u547d\u2601"], ["pixiaodan", 334, "\u516d\u6247\u95e8\u5185\u674e\u94f6\u5fc3"], [282998964, 313, "\ud80c\udda1\ud80c\udd9d\ud80c\udd9f\ud80c\udd9c\ud80c\udd9e\ud80c\udd9f"], [256060645, 303, "0UXDeNA"], [278142675, 295, "\u864emo"], [260295198, 266, "\u5c0f\u624b\u7231\u73a9"], [70348459, 255, "\u4f36\u4ec3\u7ed9\u4f60\u8bfa"], [191902505, 239, "\u6697\u591c\u730e\u624b"], [143523138, 213, "\u5984\u7559WL"], [231193411, 212, "\u5c0f\u5976\u8c46"], [121638847, 210, "\u9ed1\u5e2e\u718a\u732b"], [261080295, 199, "underdog"], [243467287, 171, "\u4e91\u6df1\u4e0d\u77e5\u5904"]]}, {"date": "2025-01-09 00:00:00", "rankings": [[284179257, 697, "MOMO2.0"], [212945898, 692, "\u70b9\u89e3\u70b9\u89e3DJ"], [130294434, 580, "\u53f8\u547d\u2601"], ["pixiaodan", 463, "\u516d\u6247\u95e8\u5185\u674e\u94f6\u5fc3"], [282998964, 335, "\ud80c\udda1\ud80c\udd9d\ud80c\udd9f\ud80c\udd9c\ud80c\udd9e\ud80c\udd9f"], [256060645, 330, "0UXDeNA"], [260295198, 317, "\u5c0f\u624b\u7231\u73a9"], [191902505, 311, "\u6697\u591c\u730e\u624b"], [70348459, 305, "\u4f36\u4ec3\u7ed9\u4f60\u8bfa"], [278142675, 301, "\u864emo"], [143523138, 240, "\u5984\u7559WL"], [231193411, 225, "\u5c0f\u5976\u8c46"], [121638847, 224, "\u9ed1\u5e2e\u718a\u732b"], [261080295, 220, "underdog"], [243467287, 180, "\u4e91\u6df1\u4e0d\u77e5\u5904"]]}, {"date": "2025-01-10 00:00:00", "rankings": [[284179257, 798, "MOMO2.0"], [212945898, 728, "\u70b9\u89e3\u70b9\u89e3DJ"], [130294434, 657, "\u53f8\u547d\u2601"], ["pixiaodan", 625, "\u516d\u6247\u95e8\u5185\u674e\u94f6\u5fc3"], [191902505, 404, "\u6697\u591c\u730e\u624b"], [256060645, 381, "0UXDeNA"], [260295198, 369, "\u5c0f\u624b\u7231\u73a9"], [282998964, 356, "\ud80c\udda1\ud80c\udd9d\ud80c\udd9f\ud80c\udd9c\ud80c\udd9e\ud80c\udd9f"], [70348459, 348, "\u4f36\u4ec3\u7ed9\u4f60\u8bfa"], [278142675, 343, "\u864emo"], [143523138, 298, "\u5984\u7559WL"], [231193411, 274, "\u5c0f\u5976\u8c46"], [261080295, 267, "underdog"], [121638847, 247, "\u9ed1\u5e2e\u718a\u732b"], [260322814, 208, "FoFo"]]}, {"date": "2025-01-11 00:00:00", "rankings": [[284179257, 868, "MOMO2.0"], [212945898, 796, "\u70b9\u89e3\u70b9\u89e3DJ"], ["pixiaodan", 734, "\u516d\u6247\u95e8\u5185\u674e\u94f6\u5fc3"], [130294434, 723, "\u53f8\u547d\u2601"], [256060645, 500, "0UXDeNA"], [191902505, 490, "\u6697\u591c\u730e\u624b"], [260295198, 413, "\u5c0f\u624b\u7231\u73a9"], [282998964, 394, "\ud80c\udda1\ud80c\udd9d\ud80c\udd9f\ud80c\udd9c\ud80c\udd9e\ud80c\udd9f"], [278142675, 385, "\u864emo"], [70348459, 356, "\u4f36\u4ec3\u7ed9\u4f60\u8bfa"], [143523138, 314, "\u5984\u7559WL"], [261080295, 291, "underdog"], [231193411, 288, "\u5c0f\u5976\u8c46"], [121638847, 260, "\u9ed1\u5e2e\u718a\u732b"], [260322814, 255, "FoFo"]]}];
        let chart;
        let previousRankings = new Map();
        let currentCounts = new Map();
        let targetIndex = 0;
        let animationSpeed = 2; // ÊØèÊ¨°Â¢ûÂä†1Êù°
        let totalCounts = new Map(); // Â≠òÂÇ®ÊØè‰∏™Êó•ÊúüÁöÑÁõÆÊ†áÂèëË®ÄÊÄªÊï∞
        let uidToLatestUserId = new Map(); // Â≠òÂÇ®UIDÂà∞ÊúÄÊñ∞User IDÁöÑÊò†Â∞Ñ
        let animate; // Â£∞ÊòéÂú®ÂÖ®Â±Ä‰ΩúÁî®Âüü
        let podiumClosed = false;  // Ê∑ªÂä†Ê†áÂøóÊù•ËøΩË∏™È¢ÅÂ•ñÂè∞Áä∂ÊÄÅ
        let autoCloseTimer = null;  // Áî®‰∫éÂ≠òÂÇ®Ëá™Âä®ÂÖ≥Èó≠ÁöÑÂÆöÊó∂Âô®
        
        // Ê£ÄÊü•Â§¥ÂÉèÊòØÂê¶Â≠òÂú®
        async function checkImageExists(uid) {
            try {
                const response = await fetch(`../avatar/${uid}.jpg`);
                return response.ok;
            } catch (e) {
                console.log(`Avatar not found for UID: ${uid}`);
                return false;
            }
        }

        // ÂàùÂßãÂåñÊØè‰∏™Êó•ÊúüÁöÑÁõÆÊ†áÂèëË®ÄÊÄªÊï∞
        function initTotalCounts() {
            rankingsData.forEach(dayData => {
                const date = dayData.date.split(' ')[0];
                const totals = new Map();
                dayData.rankings.forEach(([uid, count, user_id]) => {
                    totals.set(uid, count);
                    // Êõ¥Êñ∞Áî®Êà∑IDÊò†Â∞Ñ
                    uidToLatestUserId.set(uid, user_id);
                });
                totalCounts.set(date, totals);
            });
        }

        async function initChart() {
            const ctx = document.getElementById('rankingChart').getContext('2d');
            
            // ÂàõÂª∫Ëá™ÂÆö‰πâÊèí‰ª∂Êù•ÁªòÂà∂Â§¥ÂÉè
            const avatarPlugin = {
                id: 'avatarPlugin',
                afterDatasetsDraw: (chart) => {
                    const {ctx, scales: {x, y}} = chart;
                    
                    for (let index = 0; index < chart.data.labels.length; index++) {
                        const uid = chart.data.uids[index];
                        if (!chart.avatarCache) {
                            chart.avatarCache = new Map();
                        }
                        
                        if (!chart.avatarCache.has(uid)) {
                            const img = new Image();
                            img.src = `../avatar/${uid}.jpg`;
                            chart.avatarCache.set(uid, img);
                        }
                        
                        const img = chart.avatarCache.get(uid);
                        if (img.complete && img.naturalHeight !== 0) {
                            const xPos = x.getPixelForValue(chart.data.datasets[0].data[index]);
                            const yPos = y.getPixelForValue(index);
                            
                            const avatarSize = 30;     // Â§¥ÂÉèÂ§ßÂ∞è
                            const xOffset = -25;       // Ë¥üÂÅèÁßªÈáè
                            
                            // Âú®ÁªòÂà∂Â§¥ÂÉè‰πãÂâç‰øùÂ≠òÂΩìÂâçÁªòÂõæ‰∏ä‰∏ãÊñáÁä∂ÊÄÅ
                            ctx.save();
                            
                            // ËÆæÁΩÆÂÖ®Â±ÄÂêàÊàêÊìç‰ΩúÔºåÁ°Æ‰øùÂ§¥ÂÉèÂú®Êü±Áä∂Âõæ‰∏äÊñπ
                            ctx.globalCompositeOperation = 'source-over';
                            
                            // ÂàõÂª∫ÂúÜÂΩ¢Ë£ÅÂâ™Ë∑ØÂæÑ
                            ctx.beginPath();
                            ctx.arc(
                                xPos + xOffset,        // X ‰ΩçÁΩÆ
                                yPos,                  // Y ‰ΩçÁΩÆ
                                avatarSize/2, 
                                0, 
                                Math.PI * 2
                            );
                            ctx.closePath();
                            ctx.clip();
                            
                            // ÁªòÂà∂Â§¥ÂÉè
                            ctx.drawImage(
                                img, 
                                xPos + xOffset - avatarSize/2,  // X ‰ΩçÁΩÆ
                                yPos - avatarSize/2,            // Y ‰ΩçÁΩÆ
                                avatarSize,                     // ÂÆΩÂ∫¶
                                avatarSize                      // È´òÂ∫¶
                            );
                            
                            // ÊÅ¢Â§çÁªòÂõæ‰∏ä‰∏ãÊñáÁä∂ÊÄÅ
                            ctx.restore();
                            
                            // ÂèØÈÄâÔºöÊ∑ªÂä†Â§¥ÂÉèËæπÊ°Ü
                            ctx.beginPath();
                            ctx.arc(
                                xPos + xOffset,
                                yPos,
                                avatarSize/2,
                                0,
                                Math.PI * 2
                            );
                            ctx.strokeStyle = 'white';  // ËæπÊ°ÜÈ¢úËâ≤
                            ctx.lineWidth = 2;          // ËæπÊ°ÜÂÆΩÂ∫¶
                            ctx.stroke();
                        }
                    }
                }
            };

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    uids: [],
                    datasets: [{
                        label: 'Á¥ØËÆ°ÁõñÊ•ºÊï∞',
                        data: [],
                        backgroundColor: function(context) {
                            const index = context.dataIndex;
                            switch(index) {
                                case 0: return 'rgba(255, 215, 0, 0.8)';
                                case 1: return 'rgba(192, 192, 192, 0.8)';
                                case 2: return 'rgba(205, 127, 50, 0.8)';
                                default: return 'rgba(30, 136, 229, 0.8)';
                            }
                        },
                        borderColor: function(context) {
                            const index = context.dataIndex;
                            switch(index) {
                                case 0: return 'rgba(255, 215, 0, 1)';
                                case 1: return 'rgba(192, 192, 192, 1)';
                                case 2: return 'rgba(205, 127, 50, 1)';
                                default: return 'rgba(30, 136, 229, 1)';
                            }
                        },
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    },
                    layout: {
                        padding: {
                            right: 100 // ‰∏∫Â§¥ÂÉèÁïôÂá∫Á©∫Èó¥
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max:250,//Ê®™ÂêëÊúÄÂ§ßÂÄºÔºå‰ª•Ê≠§Áõ∏ÂØπÁº©Áü≠Êü±Áä∂ÈïøÂ∫¶
                            grid: {
                                display: false
                            },
                            ticks: {
                                display: false  // ÈöêËóèxËΩ¥ÁöÑÂàªÂ∫¶Ê†áÁ≠æ
                            },
                            border: {
                                display: false  // ÈöêËóèxËΩ¥ÁöÑËΩ¥Á∫ø
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: function(context) {
                                    const index = context.index;
                                    switch(index) {
                                        case 0: 
                                            return {
                                                size: 22,
                                                weight: 'bold',
                                                family: 'Arial'
                                            };
                                        case 1:
                                            return {
                                                size: 20,
                                                weight: 'bold',
                                                family: 'Arial'
                                            };
                                        case 2:
                                            return {
                                                size: 18,
                                                weight: 'bold',
                                                family: 'Arial'
                                            };
                                        default:
                                            return {
                                                size: 16,
                                                weight: 'normal',
                                                family: 'Arial'
                                            };
                                    }
                                },
                                color: function(context) {
                                    const index = context.index;
                                    switch(index) {
                                        case 0: return '#FFD700';
                                        case 1: return '#C0C0C0';
                                        case 2: return '#CD7F32';
                                        default: return '#444';
                                    }
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    // ‰ΩøÁî® context.dataIndex Ëé∑ÂèñÂΩìÂâçÊï∞ÊçÆÁöÑÁ¥¢Âºï
                                    const rawData = context.chart.data.rawData;  // Êàë‰ª¨ÈúÄË¶ÅÂÖàÂ≠òÂÇ®ÂéüÂßãÊï∞ÊçÆ
                                    return `Á¥ØËÆ°ÁõñÊ•ºÊï∞: ${Math.floor(rawData[context.dataIndex])}`;
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'right',
                            offset: 15,
                            color: function(context) {
                                const index = context.dataIndex;
                                // ‰∏∫Ââç‰∏âÂêçËÆæÁΩÆÁâπÊÆäÈ¢úËâ≤
                                switch(index) {
                                    case 0: return '#FFD700'; // ÈáëËâ≤
                                    case 1: return '#C0C0C0'; // Èì∂Ëâ≤
                                    case 2: return '#CD7F32'; // ÈìúËâ≤
                                    default: return '#444';
                                }
                            },
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            formatter: (value) => Math.floor(value)
                        }
                    },
                    maintainAspectRatio: false,
                    transitions: {
                        active: {
                            animation: {
                                duration: 1000
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels, avatarPlugin]
            });
            return chart;
        }

        function updateChart() {
            const currentDate = rankingsData[targetIndex].date.split(' ')[0];
            const targetTotals = totalCounts.get(currentDate);
            let allReached = true;
            let dataChanged = false;

            // ÊåÅÁª≠Â¢ûÂä†ÊØè‰∏™Áî®Êà∑ÁöÑËÆ°Êï∞
            for (const [uid, targetCount] of targetTotals) {
                if (!currentCounts.has(uid)) {
                    currentCounts.set(uid, 0);
                    dataChanged = true;
                }
                
                const current = currentCounts.get(uid);
                if (current < targetCount) {
                    currentCounts.set(uid, Math.min(current + 1, targetCount));
                    dataChanged = true;
                    allReached = false;
                }
            }

            // Âè™Âú®Êï∞ÊçÆÂèëÁîüÂèòÂåñÊó∂Êõ¥Êñ∞ÂõæË°®
            if (dataChanged) {
                const sortedUsers = Array.from(currentCounts.entries())
                    .sort((a, b) => b[1] - a[1]) // ÊåâÂèëË®ÄÊï∞ÈôçÂ∫èÊéíÂ∫è
                    .slice(0, 15);  // ÂèñÂâç10ÂêçÁî®Êà∑

                const labels = sortedUsers.map(([uid]) => uidToLatestUserId.get(uid) || uid);
                const uids = sortedUsers.map(([uid]) => uid);
                const rawData = sortedUsers.map(([, count]) => Math.floor(count));
                
                // Ëé∑ÂèñÊúÄÂ§ßÂÄº
                const maxValue = Math.max(...rawData);
                
                // Êâ©Â§ßËøáÊ∏°Âå∫Èó¥Ôºå‰ΩøËøáÊ∏°Êõ¥Âä†Âπ≥Áºì
                const transitionStart = 150;  // Êõ¥Êó©ÂºÄÂßãËøáÊ∏°
                const transitionEnd = 300;    // Êõ¥ÊôöÁªìÊùüËøáÊ∏°
                
                let data;
                if (maxValue <= transitionStart) {
                    // Âú®ËøáÊ∏°ÂºÄÂßãÂâç‰ΩøÁî®ÂéüÂßãÊï∞ÊçÆ
                    data = rawData;
                } else {
                    // ËÆ°ÁÆóËøáÊ∏°ËøõÂ∫¶
                    const progress = Math.min(
                        (maxValue - transitionStart) / (transitionEnd - transitionStart),
                        1
                    );
                    
                    // ‰ΩøÁî®Êõ¥Âπ≥ÁºìÁöÑÁºìÂä®ÂáΩÊï∞
                    const easedProgress = easeInOutQuint(progress);
                    
                    // ËÆ°ÁÆóÁõÆÊ†áÁº©ÊîæÊØî‰æãÔºåÊ∑ªÂä†ÁºìÂÜ≤Á©∫Èó¥
                    const targetScale = (chart.scales.x.max * 0.95) / maxValue;
                    
                    // Âú®ÂéüÂßãÊØî‰æã(1)ÂíåÁõÆÊ†áÁº©ÊîæÊØî‰æã‰πãÈó¥ËøõË°åÂπ≥ÊªëÊèíÂÄº
                    const currentScale = 1 + (targetScale - 1) * easedProgress;
                    
                    // Â∫îÁî®Áº©Êîæ
                    data = rawData.map(value => value * currentScale);
                }

                // Êõ¥Êñ∞ÂõæË°®Êï∞ÊçÆ
                chart.data.labels = labels;
                chart.data.uids = uids;
                chart.data.datasets[0].data = data;
                chart.data.rawData = rawData;  // Â≠òÂÇ®ÂéüÂßãÊï∞ÊçÆ‰æõ tooltip ‰ΩøÁî®
                
                // Âú®Êï∞ÊçÆÊ†áÁ≠æ‰∏≠ÂßãÁªàÊòæÁ§∫ÂéüÂßãÂÄº
                chart.options.plugins.datalabels.formatter = (value, context) => {
                    return Math.floor(rawData[context.dataIndex]);
                };

                document.getElementById('dateLabel').textContent = currentDate;
                chart.update('none');
                previousRankings = new Map(uids.map((uid, i) => [uid, i]));
            }

            // Ê£ÄÊü•ÊòØÂê¶ÊòØÊúÄÂêé‰∏ÄÂ§©‰∏îÊâÄÊúâÊï∞ÊçÆÈÉΩËææÂà∞ÁõÆÊ†á
            const isLastDay = targetIndex === rankingsData.length - 1;
            if (isLastDay && allReached && !podiumClosed) {
                setTimeout(showPodium, 300);
            }

            // Â¶ÇÊûúÊâÄÊúâÁî®Êà∑ÈÉΩËææÂà∞ÂΩìÊó•ÁõÆÊ†áÔºåËøõÂÖ•‰∏ã‰∏ÄÂ§©
            if (allReached && targetIndex < rankingsData.length - 1) {
                targetIndex++;
            }

            // ÊéßÂà∂Âä®ÁîªÈÄüÂ∫¶
            setTimeout(() => {
                if (animationInterval) {
                    requestAnimationFrame(animate);
                }
            }, 20);
        }

        function startAnimation() {
            if (!animationInterval) {
                animate = () => {
                    updateChart();
                };
                
                animationInterval = true;
                requestAnimationFrame(animate);
            }
        }

        function pauseAnimation() {
            animationInterval = false;
        }

        function resetAnimation() {
            // ÈáçÁΩÆÊâÄÊúâÁä∂ÊÄÅÂèòÈáè
            currentIndex = 0;
            targetIndex = 0;
            currentCounts = new Map();
            previousRankings = new Map();
            podiumClosed = false;
            
            // ÈöêËóèÂ•ñÊùØÊåâÈíÆ
            const awardButton = document.querySelector('.award-button');
            awardButton.style.display = 'none';
            
            // Á°Æ‰øùÈ¢ÅÂ•ñÂè∞Ë¢´ÈöêËóè
            document.querySelector('.podium-overlay').style.display = 'none';
            
            // ÈáçÁΩÆÂõæË°®
            updateChart();
            
            // Â¶ÇÊûúÂä®ÁîªÊ≠£Âú®ËøêË°åÔºåÂÖàÊöÇÂÅú
            if (animationInterval) {
                pauseAnimation();
            }
            
            // Áü≠ÊöÇÂª∂ËøüÂêéËá™Âä®ÂºÄÂßãÂä®Áîª
            setTimeout(() => {
                startAnimation();
            }, 100);
        }

        // Ê≠£Á°ÆÁöÑÂàùÂßãÂåñÈ°∫Â∫è
        async function initialize() {
            initTotalCounts();
            await initChart();
            updateChart();
            // ÂàùÂßãÂåñÊó∂ÊòæÁ§∫ÂàùÂßãÊï∞ÊçÆ
            chart.update();
        }
        
        initialize();

        function shootConfetti() {
            return confetti({
                particleCount: 20,  // Â¢ûÂä†Á≤íÂ≠êÊï∞Èáè
                origin: {
                    x: 0.5,
                    y: 0.5
                },
                colors: [
                    '#FFD700',  // ÈáëËâ≤
                    '#FF69B4',  // Á≤âÁ∫¢Ëâ≤
                    '#FFE4B5',  // Ê∑°ÈáëËâ≤
                    '#FFFFFF',  // ÁôΩËâ≤
                    '#87CEEB',  // Â§©ËìùËâ≤
                    '#98FB98',  // ÊµÖÁªøËâ≤
                    '#E6E6FA',  // Ê∑°Á¥´Ëâ≤
                ],
                gravity: 0.7,
                scalar: 1.5,
                shapes: ["circle", "square", "star"],
                disableForReducedMotion: true,
                angle: 90,
                startVelocity: 45,  // Â¢ûÂä†ÂàùÂßãÈÄüÂ∫¶
                decay: 0.9,
                spread: 150  // Â¢ûÂä†Êâ©Êï£ËåÉÂõ¥
            });
        }

        function startConfettiShow() {
            // ÂèëÂ∞Ñ‰∏ÄÊ¨°Á§ºËä±ÔºåÂπ∂Âú®ÂÆåÊàêÂêéÊ∏ÖÁêÜ
            const promise = shootConfetti();
            
            // Á≠âÂæÖÁ§ºËä±Âä®ÁîªÂÆåÊàê
            promise.then(() => {
                // Ê∏ÖÁêÜÊâÄÊúâÁ§ºËä±Áõ∏ÂÖ≥ÁöÑ canvas
                const canvases = document.querySelectorAll('canvas[style*="pointer-events: none"]');
                canvases.forEach(canvas => canvas.remove());
            });
        }

        function closePodium() {
            // Â¶ÇÊûúÂ∑≤ÁªèÂÖ≥Èó≠Ôºå‰∏çÈáçÂ§çÊâßË°å
            if (podiumClosed) return;
            
            const overlay = document.querySelector('.podium-overlay');
            overlay.classList.add('fade-out');
            
            setTimeout(() => {
                overlay.style.display = 'none';
                overlay.classList.remove('fade-out');
                
                // Âè™ÊúâÂú®Âä®ÁîªÂÆåÊàêÂêéÔºà‰∏çÊòØÈáçÁΩÆÁä∂ÊÄÅÔºâÊâçÊòæÁ§∫Â•ñÊùØÊåâÈíÆ
                if (targetIndex === rankingsData.length - 1) {
                    const awardButton = document.querySelector('.award-button');
                    awardButton.style.display = 'block';
                }
            }, 500);
            
            podiumClosed = true;
            
            // Ê∏ÖÈô§Ëá™Âä®ÂÖ≥Èó≠ÂÆöÊó∂Âô®
            if (autoCloseTimer) {
                clearTimeout(autoCloseTimer);
                autoCloseTimer = null;
            }
        }

        function showPodium(fromTrophy = false) {
            // Â¶ÇÊûúÊòØÈ¶ñÊ¨°ÊòæÁ§∫‰∏îÈ¢ÅÂ•ñÂè∞Â∑≤ÂÖ≥Èó≠ÔºåÂàôËøîÂõû
            if (!fromTrophy && podiumClosed) {
                return;
            }
            
            console.log("Showing podium...");
            
            // Ê∏ÖÈô§‰ªª‰ΩïÁé∞ÊúâÁöÑËá™Âä®ÂÖ≥Èó≠ÂÆöÊó∂Âô®
            if (autoCloseTimer) {
                clearTimeout(autoCloseTimer);
                autoCloseTimer = null;
            }
            
            const winners = Array.from(currentCounts.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);
            
            const overlay = document.querySelector('.podium-overlay');
            
            // ÈáçÁΩÆÈ¢ÅÂ•ñÂè∞Áä∂ÊÄÅ
            podiumClosed = false;
            
            // ËÆæÁΩÆËé∑Â•ñËÄÖ‰ø°ÊÅØ
            winners.forEach((winner, index) => {
                const [uid, score] = winner;
                const step = document.querySelector(`.${['gold', 'silver', 'bronze'][index]}`);
                const avatar = step.querySelector('.winner-avatar');
                const name = step.querySelector('.winner-name');
                const scoreEl = step.querySelector('.winner-score');
                
                avatar.src = `../avatar/${uid}.jpg`;
                name.textContent = uidToLatestUserId.get(uid);
                scoreEl.textContent = `ÁõñÊ•º ${Math.floor(score)} Â±Ç`;
            });
            
            // ÊòæÁ§∫È¢ÅÂ•ñÂè∞
            overlay.style.display = 'flex';
            
            // Âè™Âú®È¶ñÊ¨°ÊòæÁ§∫Êó∂Êí≠ÊîæÁ§ºËä±ÂíåËÆæÁΩÆËá™Âä®ÂÖ≥Èó≠
            if (!fromTrophy) {
                setTimeout(() => {
                    startConfettiShow();
                }, 500);
                
                // 10ÁßíÂêéËá™Âä®ÂÖ≥Èó≠È¢ÅÂ•ñÂè∞
                autoCloseTimer = setTimeout(() => {
                    if (!podiumClosed) {
                        closePodium();
                    }
                }, 10000);
            }
        }

        // ‰∏∫Â•ñÊùØÊåâÈíÆÊ∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
        document.querySelector('.award-button').addEventListener('click', function(e) {
            e.preventDefault();  // Èò≤Ê≠¢‰∫ã‰ª∂ÂÜíÊ≥°
            console.log("Trophy button clicked");
            showPodium(true);
        });

        // ‰øÆÊîπÂÖ≥Èó≠ÊåâÈíÆ‰∫ã‰ª∂
        document.querySelector('.close-podium').addEventListener('click', function(e) {
            e.preventDefault();  // Èò≤Ê≠¢‰∫ã‰ª∂ÂÜíÊ≥°
            closePodium();
        });

        // ‰øÆÊîπ‰∏∫Êõ¥Âπ≥ÁºìÁöÑÁºìÂä®ÂáΩÊï∞
        function easeInOutQuint(x) {
            // ‰∫îÊ¨°ÊñπÁöÑÁºìÂä®ÂáΩÊï∞ÔºåÊèê‰æõÊõ¥Âπ≥ÁºìÁöÑÂä†ÈÄüÂíåÂáèÈÄü
            return x < 0.5 ? 16 * x * x * x * x * x : 1 - Math.pow(-2 * x + 2, 5) / 2;
        }
    </script>
</body>
</html>
